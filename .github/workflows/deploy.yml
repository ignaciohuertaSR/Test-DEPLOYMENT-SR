name: Quick Deploy (force success)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: false
        default: 'production'
      issue_key:
        description: 'Optional Jira issue key (e.g. PROJ-123)'
        required: false
      environment_url:
        description: 'URL for the deployed environment'
        required: false
        default: 'https://example.com'

jobs:
  build:
    name: Build (simulated, always success)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run project build (if present)
        run: |
          set -e
          echo "Checking for common build files..."
          if [ -f package.json ]; then
            echo "Detected Node project. Installing dependencies and running tests (errors ignored)."
            if command -v npm >/dev/null 2>&1; then
              npm ci || true
              npm test || true
            else
              echo "npm not found; skipping Node build steps"
            fi
          elif [ -f pom.xml ]; then
            echo "Detected Maven project. Running mvn - errors ignored."
            mvn -q -DskipTests=false test || true
          else
            echo "No recognised build file found; running a noop build."
          fi
          echo "Build finished (forced success)."

  deploy:
    name: Create deployment and mark success
    needs: build
    runs-on: ubuntu-latest

    permissions:
      deployments: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build payload
        id: build_payload
        run: |
          ISSUE_KEY='${{ github.event.inputs.issue_key }}'
          if [ -n "$ISSUE_KEY" ]; then
            PAYLOAD=$(printf '{"issueKeys":["%s"],"build":"success"}' "$ISSUE_KEY")
          else
            PAYLOAD='{"build":"success"}'
          fi
          echo "DEPLOY_PAYLOAD=$PAYLOAD" >> $GITHUB_ENV

      - name: Create GitHub deployment
        id: deployment
        uses: chrnorm/deployment-action@v2
        with:
          token: ${{ github.token }}
          environment: ${{ github.event.inputs.environment }}
          environment-url: ${{ github.event.inputs.environment_url }}
          description: "Manual quick deploy (force success)"
          payload: ${{ env.DEPLOY_PAYLOAD }}

      - name: Start ssh-agent and add SSH key
        uses: webfactory/ssh-agent@v0.8.1
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Add remote host to known_hosts
        run: |
          set -e
          HOST=${{ secrets.DEPLOY_HOST }}
          PORT=${{ secrets.DEPLOY_PORT }}
          mkdir -p ~/.ssh
          if [ -n "$HOST" ]; then
            if [ -n "$PORT" ]; then
              ssh-keyscan -p $PORT $HOST >> ~/.ssh/known_hosts
            else
              ssh-keyscan $HOST >> ~/.ssh/known_hosts
            fi
            chmod 644 ~/.ssh/known_hosts
            echo "Added $HOST to known_hosts"
          else
            echo "No DEPLOY_HOST set; skipping known_hosts setup"
          fi

      - name: Upload files via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || '22' }}
          source: '.'
          target: ${{ secrets.DEPLOY_PATH }}

      - name: Mark deployment success (always)
        if: always() && steps.deployment.outputs.deployment_id != ''
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ github.token }}
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}
          environment-url: ${{ steps.deployment.outputs.environment_url }}
          state: 'success'

      - name: Fallback success message
        if: always() && steps.deployment.outputs.deployment_id == ''
        run: |
          echo "No deployment id returned; nothing to mark. Exiting with success as requested."

# Notes:
# - This workflow is manual (`workflow_dispatch`) and will create a GitHub Deployment then immediately
#   mark it `success`. If you want deployment events to trigger other workflows, create a personal
#   access token with appropriate permissions and store it as `GITHUB_DEPLOY_TOKEN`, then replace
#   `github.token` with `secrets.GITHUB_DEPLOY_TOKEN` in the `token` inputs above.