

name: Deployment (chrnorm/deployment-action)

permissions:
  deployments: write

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment (overrides default)'
        required: false
        default: 'production'
      issue_key:
        description: 'Optional Jira issue key to associate (e.g. PROJ-123)'
        required: false
      environment_url:
        description: 'URL for the deployed environment'
        required: false
        default: 'https://example.com'

jobs:
  deploy:
    name: Create and run deployment
    runs-on: ubuntu-latest

    permissions:
      deployments: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build deployment payload (Jira integration)
        id: build_payload
        run: |
          ISSUE_KEY='${{ github.event.inputs.issue_key }}'
          if [ -n "$ISSUE_KEY" ]; then
            PAYLOAD=$(printf '{"issueKeys":["%s"]}' "$ISSUE_KEY")
          else
            PAYLOAD='{}'
          fi
          echo "DEPLOY_PAYLOAD=$PAYLOAD" >> $GITHUB_ENV

      - name: Create GitHub deployment
        id: deployment
        uses: chrnorm/deployment-action@v2
        with:
          token: ${{ secrets.GITHUB_DEPLOY_TOKEN || github.token }}
          owner: ${{ github.repository_owner }}
          repo: ${{ github.repository }}
          environment: ${{ github.event.inputs.environment }}
          environment-url: ${{ github.event.inputs.environment_url }}
          description: "Deploy triggered by GitHub Actions"
          payload: ${{ env.DEPLOY_PAYLOAD }}

      - name: Deploy my app (placeholder)
        run: |
          echo "Add your deployment commands here (this is a placeholder)."

      - name: Update deployment status (success)
        if: success()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ secrets.GITHUB_DEPLOY_TOKEN || github.token }}
          owner: ${{ github.repository_owner }}
          repo: ${{ github.repository }}
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}
          environment-url: ${{ steps.deployment.outputs.environment_url }}
          state: 'success'

      - name: Update deployment status (failure)
        if: failure()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ secrets.GITHUB_DEPLOY_TOKEN || github.token }}
          owner: ${{ github.repository_owner }}
          repo: ${{ github.repository }}
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}
          environment-url: ${{ steps.deployment.outputs.environment_url }}
          state: 'failure'

# Notes:
# - This workflow creates a GitHub Deployment using `chrnorm/deployment-action@v2` and updates
#   the deployment status with `chrnorm/deployment-status@v2`.
# - If you need deployment events to trigger other workflows, create a personal access token
#   with `repo` and `workflow` permissions and store it as the secret `GITHUB_DEPLOY_TOKEN`, then
#   replace `github.token` with `secrets.GITHUB_DEPLOY_TOKEN` in the `token` inputs above.
# - This workflow is manual (`workflow_dispatch`) and will create a GitHub Deployment then immediately
#   mark it `success`. If you want deployment events to trigger other workflows, create a personal
#   access token with appropriate permissions and store it as `GITHUB_DEPLOY_TOKEN`, then replace
#   `github.token` with `secrets.GITHUB_DEPLOY_TOKEN` in the `token` inputs above.